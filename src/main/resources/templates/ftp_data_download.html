<div th:with="pageTitle = '流水监控'" th:include="comm/public/header" xmlns:th="http://www.w3.org/1999/xhtml"></div>
<body xmlns:th="http://www.w3.org/1999/xhtml">
<div th:include="comm/public/nav"></div>

<div id="app" class="container">
    <div th:include="comm/public/alert" xmlns:th="http://www.w3.org/1999/xhtml"></div>
    <form class="bs-example bs-example-form" role="form">
        <div class="row">
            <div class="col-lg-6">
                <div class="input-group">
                    <div class="input-group-btn">
                        <button type="button" class="btn btn-primary dropdown-toggle"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            {{retailerSelected}} <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li v-for="(retailer,index) in retailerList"><a @click="selectRetailer(retailer)">
                                {{retailer.retailerName}}</a>
                            </li>
                        </ul>
                    </div><!-- /btn-group -->
                    <input id="pickDate" type="text" class="form-control" placeholder="选择日期"
                           style="width :200px;margin-left: 40px; " readonly>
                    <span class="input-group-btn" style="margin-left: -80px">
						<button class="btn btn-info" type="button" @click="downloadData()">
							开始下载
						</button>
					</span>
                </div><!-- /input-group -->
            </div>
        </div><!-- /.row -->
    </form>
</div>
<script type="text/javascript">
    let currentDay = initDate();

    function initDate() {
        const date = new Date();
        const year = date.getFullYear();
        let month = date.getMonth() + 1;
        let day = date.getDate();
        if (month < 10) {
            month = "0" + month
        }
        if (day < 10) {
            day = "0" + day
        }
        return year + "-" + month + "-" + day
    }

    $(function () {
        $('#pickDate').val(initDate());
        $("[data-toggle='popover']").popover();
        $('#pickDate').datetimepicker({
            format: 'yyyy-mm-dd',  //格式  如果只有yyyy-mm-dd那就是0000-00-00
            autoclose: true,//选择后是否自动关闭
            minView: 2,//最精准的时间选择为日期  0-分 1-时 2-日 3-月
            language: 'zh-CN', //中文
            weekStart: 1, //一周从星期几开始
            todayBtn: 1,
            autoclose: 1,
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            // daysOfWeekDisabled:"1,2,3", //一周的周几不能选 格式为"1,2,3"  数组格式也行
            todayBtn: true,  //在底部是否显示今天
            todayHighlight: false, //今天是否高亮显示
            keyboardNavigation: true, //方向图标改变日期  必须要有img文件夹 里面存放图标
            showMeridian: false,  //是否出现 上下午
            initialDate: new Date(),
            startDate: "2017-01-01" //日期开始时间 也可以是new Date()只能选择以后的时间
        }).on("changeDate", function () {
            currentDay = $('#pickDate').val();
        });
    });

    new Vue({
        el: '#app',
        data: {
            retailerList: [{}],
            fileList: [],
            realRowNumberList: [],
            checkRowNumberList: [],
            differenceNumList: [],
            retailerSelected: '美宜佳',
            retailerCodeSelected: 'R10001',
            msg: "日常零售商数据采集!"
        },
        created() {
            this.initRetailer();
        },
        methods: {
            downloadData() {
                const _this = this;
                _this.download(_this.retailerCodeSelected, currentDay, false)
            },
            download(retailerCode, day, overwrite) {
                const _this = this;
                const url = "/retailer/data/ftp?retailerCode=" + retailerCode
                    + "&day=" + day + "&overwrite=" + overwrite;
                axios.get(url).then(function (res) {
                    const success = res.data.success;
                    if (success) {
                        _this.msg = retailerCode + " " + day + " 日的FTP数据下载成功！";
                    }
                }).catch(function (reason) {
                    console.log(reason);
                    _this.msg = reason;
                });
            },
            selectRetailer(retailer) {
                this.retailerSelected = retailer.retailerName;
                this.retailerCodeSelected = retailer.retailerCode
            },
            initRetailer() {
                const url = "/api/retailer/list/config";
                const _this = this;
                axios.get(url).then(function (res) {
                    console.log(res);
                    _this.retailerList = res.data.payload;
                }).catch(function (reason) {
                    console.log(reason)
                });
            }
        }
    });
</script>
</body>
</html>
